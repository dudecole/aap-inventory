---
- name: Create a directory for a backup to live.
  file:
    path: '{{ backup_dir.rstrip("/") }}/{{ now }}/'
    mode: 0755
    owner: root
    state: directory
  notify: Remove the backup directory.

- block:
    - name: Create a directory for non-instance specific backups
      file:
        path: '{{ backup_dir.rstrip("/") }}/common/'
        mode: 0700
        owner: root
        state: directory
      notify: Remove common directory.

    - name: Get tower database settings
      shell: "awx-manage print_settings | grep '^DATABASES'"
      register: results
      changed_when: False
      no_log: True

    - name: Ingest tower database settings
      set_fact:
        controller_db_settings: "{{ results.stdout | regex_replace('DATABASES\\s+= ', '') }}"
      no_log: True

  when:
    - groups['automationcontroller'] | default([]) | length
    - inventory_hostname == groups['automationcontroller'][0]

- block:
    - name: Create a directory for hub specific backups
      file:
        path: '{{ backup_dir.rstrip("/") }}/automationhub/automationhub/'
        mode: 0711
        owner: root
        state: directory
      notify: Remove automationhub directory.

    - name: Get hub database settings
      shell: "grep '^DATABASES' /etc/pulp/settings.py"
      register: ah_database_settings
      changed_when: false
      no_log: true

    - name: Ingest hub database settings
      set_fact:
        automationhub_db_settings: "{{ ah_database_settings.stdout | regex_replace('DATABASES\\s+= ', '') }}"
      no_log: true

  when:
    - inventory_hostname in groups['automationhub'] | default([])

- block:
    - name: Create a directory for catalog specific backups
      file:
        path: '{{ backup_dir.rstrip("/") }}/automationcatalog/automationcatalog/'
        mode: 0711
        owner: root
        state: directory
      notify: Remove automationcatalog directory.

    - name: Slurp catalog settings file
      slurp:
        src: '/etc/ansible-automation-platform/services-catalog/settings'
      register: catalog_settings

    - set_fact:
        automationcatalog_db_settings:
          name: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_DATABASE_NAME=(.+)', '\\1') | combine }}"
          host: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_POSTGRES_HOST=(.+)', '\\1') | combine }}"
          port: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_POSTGRES_PORT=(.+)', '\\1') | combine }}"
          user: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_POSTGRES_USER=(.+)', '\\1') | combine }}"
          password: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_POSTGRES_PASSWORD=(.+)', '\\1') | combine }}"
        automationcatalog_backup_settings:
          controller_token: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_CONTROLLER_TOKEN=.+') }}"
          keycloak_secret: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_KEYCLOAK_CLIENT_SECRET=.+') }}"
          secret_key: "{{ catalog_settings['content'] | b64decode | regex_search('PINAKES_SECRET_KEY=.+') }}"
      no_log: true

  when:
    - inventory_hostname in groups['automationcatalog'] | default([])

- block:
    - name: Create a directory for sso specific backups
      file:
        path: '{{ backup_dir.rstrip("/") }}/sso/'
        mode: 0711
        owner: root
        state: directory
      notify: Remove sso directory.

    - include_vars: ../roles/sso/defaults/main.yml

  when:
    - inventory_hostname in groups['sso'] | default([])
