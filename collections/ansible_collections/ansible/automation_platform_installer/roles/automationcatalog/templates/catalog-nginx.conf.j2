#jinja2: lstrip_blocks: True

server_tokens               off;
access_log                  /var/log/nginx/catalog.access.log;
error_log                   /var/log/nginx/catalog.error.log;
server_names_hash_bucket_size 128;

upstream catalog-api {
    server unix:/var/run/ansible-automation-platform/services-catalog.sock;
}

server {

  listen                   {{ _automationcatalog_https_port }} ssl;
  {% if ansible_all_ipv6_addresses != [] %}
  listen [::]:{{ _automationcatalog_https_port }} ssl;
  {% endif %}
  server_name               {{ _automationcatalog_allowed_hostnames | flatten | join(' ') }};
  ssl_certificate           /etc/ansible-automation-platform/services-catalog/server.cert;
  ssl_certificate_key       /etc/ansible-automation-platform/services-catalog/server.key;

  # RHEL system crypto policy
  ssl_ciphers PROFILE=SYSTEM;
  ssl_prefer_server_ciphers on;

  {% if not automationcatalog_disable_hsts | bool %}
  # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
  add_header Strict-Transport-Security max-age=15768000;
  {% endif %}

  # headers added with nginx_user_headers variable
{% for header in automationcatalog_user_headers %}
  add_header {{ header }}
{% endfor %}
  # end of headers added with nginx_user_headers variable

  # Protect against click-jacking https://www.owasp.org/index.php/Testing_for_Clickjacking_(OTG-CLIENT-009)
  add_header X-Frame-Options "DENY";

  location ~ ^/(api|login|complete)/ {
    proxy_pass              http://catalog-api;
    proxy_set_header        Host $host;
    proxy_set_header        X-Forwarded-Proto $scheme;
    proxy_set_header        X-Forwarded-Host $host;
    proxy_set_header        X-Forwarded-Port $server_port;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /favicon.ico {
    alias /var/lib/ansible-automation-platform/services-catalog/public/static/catalog/favicon.ico;
  }

  location /ui {
    alias /var/lib/ansible-automation-platform/services-catalog/public/static;
    try_files $uri $uri/ /catalog/index.html =404;
  }

  location /media {
    alias /var/lib/ansible-automation-platform/services-catalog/public/media;
  }

  location / {
    rewrite ^/$ $scheme://$host:$server_port/ui/catalog/index.html redirect;

    # HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
    add_header Strict-Transport-Security max-age=15768000;

    # Protect against click-jacking https://www.owasp.org/index.php/Testing_for_Clickjacking_(OTG-CLIENT-009)
    add_header X-Frame-Options "DENY";
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Expires "0";
    add_header Pragma "no-cache";
  }

}

{% if not automationcatalog_disable_https|bool %}
server {
    listen {{ _automationcatalog_http_port }} default_server;
    {% if ansible_all_ipv6_addresses != [] %}
    listen [::]:{{ _automationcatalog_http_port }} default_server;
    {% endif %}
    server_name {{ _automationcatalog_allowed_hostnames | flatten | join(' ') }};
    {% if _automationcatalog_http_port|string == "443" %}
    return 301 https://$host$request_uri;
    {% else %}
    return 301 https://$host:{{ _automationcatalog_https_port }}$request_uri;
    {% endif %}
}
{% endif %}
